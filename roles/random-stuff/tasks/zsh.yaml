- name: Install zsh
  apt:
    name:
      - command-not-found
      - zsh
  become: yes
  tags: packages

- name: Clone oh-my-zsh
  git:
    repo: https://github.com/robbyrussell/oh-my-zsh/
    dest: "{{ ansible_user_dir }}/.oh-my-zsh"
    update: no
  tags:
    - configuration
    - oh-my-zsh

- name: Copy .zshrc template from oh my zsh
  copy:
    src: "{{ ansible_user_dir }}/.oh-my-zsh/templates/zshrc.zsh-template"
    dest: "{{ ansible_user_dir }}/.zshrc"
    remote_src: yes
    force: no
  tags:
    - configuration
    - oh-my-zsh
    - zshrc

- name: Set custom variables in zshrc
  lineinfile:
    path: "{{ ansible_user_dir }}/.zshrc"
    regexp: "^[# ]*{{ item.name }}="
    line: '{{ item.name }}="{{ item.value }}"'
    insertbefore: source \$ZSH/oh-my-zsh.sh
  loop:
    - { name: "COMPLETION_WAITING_DOTS", value: "true" }
    - { name: "DISABLE_AUTO_UPDATE", value: "true" }
    - { name: "DISABLE_UNTRACKED_FILES_DIRTY", value: "true" }
    - { name: "ZSH_CUSTOM", value: "$HOME/.zsh_custom/" }
    - { name: "ZSH_THEME", value: "aussiegeek" }
    - { name: "ZSH_TMUX_AUTOSTART", value: "true" }
    - { name: "ZSH_TMUX_AUTOQUIT", value: "false" }
  tags:
    - configuration
    - oh-my-zsh
    - zshrc

- name: Load oh-my-zsh plugins
  lineinfile:
    path: "{{ ansible_user_dir }}/.zshrc"
    line: plugins+=({{ item }})
    insertbefore: source \$ZSH/oh-my-zsh.sh
  loop:
    - command-not-found
    - fzf
    - jump
    - tmux
    - zsh-autosuggestions

- name: Create zsh directories
  file:
    path: "{{ item }}"
    state: directory
    mode: 0755
  with_items:
    - "{{ ansible_user_dir }}/.marks"
    - "{{ ansible_user_dir }}/.zsh_custom"

- name: Add some aliases
  lineinfile:
    path: "{{ zsh_custom_directory }}/alias.zsh"
    regexp: "^[#\\s]*alias\\s+{{ item.alias | regex_escape() }}="
    line: "alias {{ item.alias }}=\"{{ item.value }}\""
    create: yes
  with_items:
    - { alias: 'e', value: 'editor' }
    - { alias: 'j', value: 'jump' }
    - { alias: 'o', value: 'xdg-open' }

- name: Clone fzf
  git:
    repo: https://github.com/junegunn/fzf
    dest: "{{ ansible_user_dir }}/.fzf"
    update: no
  tags:
    - configuration
    - fzf

# TODO: Don't depend on versioned url
- name: Download fzf executable
  unarchive:
    src: https://github.com/junegunn/fzf-bin/releases/download/0.17.5/fzf-0.17.5-linux_amd64.tgz
    dest: "{{ ansible_user_dir }}/.fzf/bin/"
    remote_src: yes
    creates: "{{ ansible_user_dir }}/.fzf/bin/fzf"
  tags:
    - configuration
    - fzf

- name: Configure fzf loading
  copy:
    content: |
      export FZF_HOME=~/.fzf/
      # Setup fzf
      # ---------
      if [[ ! "$PATH" == *$FZF_HOME/bin* ]]; then
        export PATH="$PATH:$FZF_HOME/bin"
      fi

      # Auto-completion
      # ---------------
      [[ $- == *i* ]] && source "$FZF_HOME/shell/completion.zsh" 2> /dev/null

      # Key bindings
      # ------------
      source "$FZF_HOME/shell/key-bindings.zsh"

    dest: "{{ zsh_custom_directory }}/fzf.zsh"
    mode: 0644
  tags:
    - configuration
    - fzf

- name: Clone zsh-autosuggestions
  git:
    repo: https://github.com/zsh-users/zsh-autosuggestions
    dest: "{{ ansible_user_dir }}/.zsh_custom/plugins/zsh-autosuggestions"
    update: no
  tags:
    - configuration
    - oh-my-zsh

- name: Set {{ ansible_user_id }} shell to zsh
  user:
    name: "{{ ansible_user_id }}"
    shell: /bin/zsh
  become: yes
